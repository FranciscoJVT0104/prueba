<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador de plantilla CSV para Moodle</title>
  <style>
    :root{font-family:Inter,Arial,Helvetica,sans-serif;color:#1f2937}
    body{max-width:1000px;margin:24px auto;padding:18px}
    h1{font-size:20px;margin-bottom:6px}
    p.lead{margin-top:0;color:#374151}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input[type=file]{padding:6px}
    button{background:#0369a1;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#64748b}
    button.ghost{background:transparent;color:#0369a1;border:1px solid #cbd5e1}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{border:1px solid #e2e8f0;padding:8px;text-align:left}
    th{background:#f1f5f9}
    td[contenteditable]{background:#fbfdff}
    .small{font-size:13px;color:#475569}
    .footer{margin-top:12px;color:#475569;font-size:13px}
    .row-actions{display:flex;gap:6px}
    .danger{background:#ef4444}
    label.inline{display:flex;gap:6px;align-items:center}
    .note{background:#f8fafc;border-left:4px solid #cbd5e1;padding:8px;margin:8px 0}
    .kbd{background:#efefef;border-radius:4px;padding:2px 6px;font-family:monospace}
  </style>
</head>
<body>
  <h1>Generador de CSV para matricular y activar cuestionarios en Moodle</h1>
  <p class="lead">Carga tu CSV inicial (separador <span class="kbd">|</span> o <span class="kbd">;</span>), edítalo si hace falta y genera la plantilla final en formato <span class="kbd">|</span> lista para importar a Moodle.</p>

  <div class="controls">
    <input id="fileInput" type="file" accept=".csv" />
    <div id="dropZone" style="border:2px dashed #0369a1;padding:20px;text-align:center;border-radius:8px;color:#0369a1;cursor:pointer;">Arrastra aquí tu archivo CSV</div>
    <button id="btnLoadTemplate" class="secondary">Cargar plantilla de ejemplo</button>
    <button id="btnAddRow" class="ghost">Agregar fila</button>
    <button id="btnGenerate">Generar y descargar CSV para Moodle</button>
    <button id="btnClear" class="secondary">Limpiar tabla</button>
  </div>

  <div class="note">
    <strong>Encabezado esperado (entrada):</strong>
    <div class="small">firstname | lastname | CELLPHONE | DNI | course1 | group1 | fecha de inicio | hora de inicio | fecha de fin | hora de fin | duracion de cuestionario | INTENTOS</div>
    <div class="small" style="margin-top:6px">Salida generada: <span class="kbd">username|password|firstname|lastname|email|CELLPHONE|course1|group1|fecha de inicio|hora de inicio|fecha de fin|hora de fin|duracion de cuestionario|INTENTOS</span></div>
  </div>

  <div id="tableContainer"></div>

  <div class="footer">
    <p class="small">Reglas aplicadas:</p>
    <ul class="small">
      <li>username = DNI</li>
      <li>password = DNI + (primera letra del primer apellido) + (primera letra del primer nombre), en mayúsculas</li>
      <li>email = DNI + "s@actualizar.com"</li>
    </ul>
  </div>

  <script>
    // Utilidades
    function crearTablaVacia() {
      const headers = [
        'firstname','lastname','CELLPHONE','DNI','course1','group1','fecha de inicio','hora de inicio','fecha de fin','hora de fin','duracion de cuestionario','INTENTOS'
      ];
      const table = document.createElement('table');
      table.id = 'inputTable';
      const thead = document.createElement('thead');
      const tr = document.createElement('tr');
      headers.forEach(h => { const th=document.createElement('th'); th.innerText=h; tr.appendChild(th); });
      thead.appendChild(tr);
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      table.appendChild(tbody);
      return table;
    }

    function agregarFilaConDatos(arr) {
      const table = document.getElementById('inputTable') || (() => { document.getElementById('tableContainer').appendChild(crearTablaVacia()); return document.getElementById('inputTable'); })();
      const tbody = table.querySelector('tbody');
      const tr = document.createElement('tr');
      for (let i=0;i<12;i++){
        const td = document.createElement('td');
        td.contentEditable = 'true';
        td.innerText = arr && arr[i] != null ? arr[i] : '';
        tr.appendChild(td);
      }
      const actionTd = document.createElement('td');
      actionTd.innerHTML = '<div class="row-actions"><button class="ghost" data-action="up">↑</button><button class="ghost" data-action="down">↓</button><button class="danger" data-action="del">Eliminar</button></div>';
      tr.appendChild(actionTd);
      tbody.appendChild(tr);
    }

    function parseCSVText(text) {
      // Detect separator: prefer | then ; then ,
      let sep = '|';
      if (text.indexOf('|') === -1) sep = text.indexOf(';') !== -1 ? ';' : ',';
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const rows = lines.map(line => line.split(sep).map(c=>c.trim()));
      return rows;
    }

    function loadRowsIntoTable(rows) {
      const container = document.getElementById('tableContainer');
      container.innerHTML = '';
      const table = crearTablaVacia();
      const tbody = table.querySelector('tbody');
      rows.forEach((r,idx)=>{
        if (idx===0) return; // omit header if provided
        const tr = document.createElement('tr');
        for (let i=0;i<12;i++){
          const td = document.createElement('td'); td.contentEditable='true'; td.innerText = r[i] || ''; tr.appendChild(td);
        }
        const actionTd = document.createElement('td');
        actionTd.innerHTML = '<div class="row-actions"><button class="ghost" data-action="up">↑</button><button class="ghost" data-action="down">↓</button><button class="danger" data-action="del">Eliminar</button></div>';
        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
      container.appendChild(table);
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = '#e0f2fe'; });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.background = 'transparent'; });
    dropZone.addEventListener('drop', e => {
      e.preventDefault(); dropZone.style.background = 'transparent';
      const file = e.dataTransfer.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { const rows = parseCSVText(ev.target.result); loadRowsIntoTable(rows); };
      reader.readAsText(file,'UTF-8');
    });

    // Cargar archivo por input
    document.getElementById('fileInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const rows = parseCSVText(ev.target.result);
          loadRowsIntoTable(rows);
        }catch(err){ alert('Error al parsear CSV: '+err.message); }
      };
      reader.readAsText(file,'UTF-8');
    });

    // Ejemplo rápido
    document.getElementById('btnLoadTemplate').addEventListener('click', function(){
      const example = `firstname|lastname|CELLPHONE|DNI|course1|group1|fecha de inicio|hora de inicio|fecha de fin|hora de fin|duracion de cuestionario|INTENTOS\nJULIA MERCEDES|AGUILAR BEAZLEY|919473627|46107147|c1|REC-1542|27/11/2025|00:00|30/11/2025|23:59|30 minutos|1\nTRAICI CAMILA|SALVADOR HUAMANI|924173331|75376908|c2|REC-1540|26/11/2025|00:00|29/11/2025|23:59|30 minutos|2`;
      const rows = parseCSVText(example);
      loadRowsIntoTable(rows);
    });

    // Agregar fila vacía
    document.getElementById('btnAddRow').addEventListener('click', function(){ agregarFilaConDatos(); });

    // Delegación acciones de fila (subir, bajar, borrar)
    document.getElementById('tableContainer').addEventListener('click', function(e){
      const action = e.target.getAttribute('data-action');
      if (!action) return;
      const tr = e.target.closest('tr');
      if (!tr) return;
      if (action === 'del') tr.remove();
      if (action === 'up') { const p = tr.previousElementSibling; if (p) tr.parentNode.insertBefore(tr,p); }
      if (action === 'down') { const n = tr.nextElementSibling; if (n) tr.parentNode.insertBefore(n,tr); }
    });

    // Limpiar
    document.getElementById('btnClear').addEventListener('click', function(){ document.getElementById('tableContainer').innerHTML = ''; });

    // Generar CSV final y descargar (| separated)
    document.getElementById('btnGenerate').addEventListener('click', function(){
      const table = document.getElementById('inputTable');
      if (!table) return alert('No hay datos en la tabla.');
      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr=>Array.from(tr.querySelectorAll('td')).slice(0,12).map(td=>td.innerText.trim()));
      if (rows.length===0) return alert('No hay filas para procesar.');

      const headerOut = ['username','password','firstname','lastname','email','CELLPHONE','course1','group1','fecha de inicio','hora de inicio','fecha de fin','hora de fin','duracion de cuestionario','INTENTOS'];

      const outRows = rows.map(r=>{
        const firstname = r[0]||'';
        const lastname = r[1]||'';
        const cellphone = r[2]||'';
        const dni = r[3]||'';
        const course1 = r[4]||'';
        const group1 = r[5]||'';
        const fInicio = r[6]||'';
        const hInicio = r[7]||'';
        const fFin = r[8]||'';
        const hFin = r[9]||'';
        const dur = r[10]||'';
        const intentos = r[11]||'';

        // obtener primeras letras
        function primeraLetraPrimerPalabra(t){ if(!t) return ''; const w = t.trim().split(/\s+/)[0]; return w.charAt(0).toUpperCase(); }
        const pw = String(dni) + primeraLetraPrimerPalabra(lastname) + primeraLetraPrimerPalabra(firstname);
        const email = String(dni) + 's@actualizar.com';

        return [String(dni), pw.toUpperCase(), firstname, lastname, email, cellphone, course1, group1, fInicio, hInicio, fFin, hFin, dur, intentos];
      });

      // Construir CSV con BOM y separador |
      const sep = '|';
      const lines = [headerOut.join(sep)].concat(outRows.map(r=>r.map(v=>v==null? '': String(v)).join(sep)));
      const bom = '\uFEFF';
      const blob = new Blob([bom + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'MOODLE_IMPORT.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    // Cargar template al inicio para conveniencia
    // document.getElementById('btnLoadTemplate').click();
  </script>
</body>
</html>
